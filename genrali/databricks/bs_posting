# Databricks notebook source
dbutils.widgets.text("Run_Id","")
dbutils.widgets.text("Source_System","")

Run_Id = dbutils.widgets.get("Run_Id")
Source_System = dbutils.widgets.get("Source_System")

# COMMAND ----------

# DBTITLE 1,BS_Posting
spark.sql(
    f"""
    INSERT INTO fdp.bdv.BS_POSTING (
        Posting_Bk,
        H_Posting_Hk,
        Invalid_dts,
        Hash_Diff,
        Run_Id,
        Load_Dts,
        Rec_Src,
        Source_System,
        Company_Cd,
        Cost_Unit,
        Transaction_Id,
        Accrual_Date_For_Expenses_Dt,
        Business_Record_Dt,
        Cancellation_Dt,
        Cost_Element,
        Accounting_Area_General_Ledger_Id,
        Accrual_Date_For_Revenue_Dt,
        Cancellation_Flag,
        Creation_Dt,
        Cancellation_Originator,
        Event_Dt,
        Manual_Posting,
        Cancellation_Originator_Instance,
        Distribution_Channel_Id,
        Manually_Overridden,
        Posting_Status,
        Cancellation_Originator_Instance_Value,
        Manually_Override_Allowed,
        Posting_Accounting_Period_Begin_Dt,
        Cancellation_Reason,
        Origin_Language_Iso,
        Posting_Accounting_Period_End_Dt,
        Cancellation_Reason_Road,
        Origin_System_Type,
        Posting_Dt,
        Cancellation_Retracted,
        Posting_Type,
        Processing_Dt,
        Cancellation_Type,
        Posting_Origin,
        Processing_Status,
        Transaction_Posting_Id,
        Reference_Curr_Rounding_Rule_Amt,
        Storno_Version_Nbr,
        Status_Indicator,
        Transaction_Amt,
        Transaction_Desc,
        Transaction_Reference_Id,
        Transaction_Type,
        Transaction_Unit,
        Accident_Year,
        Country,
        Asset_Class,
        Movement_Type,
        Reinsurance_Cover_Type,
        Risk_Location,
        Underwriting_Year,
        Reinsurance_Type,
        Document_Type
    )

    SELECT 
    src.Posting_Bk,
         src.H_Posting_Hk,
         '9999-12-31 23:59:59' AS Invalid_Dts,
         src.Hash_Diff,
         '{Run_Id}' AS Run_Id,
         current_timestamp() AS Load_Dts,
         src.Rec_Src,
         '{Source_System}' AS Source_System,
        src.Company_Cd,
        src.Cost_Unit,
        src.Transaction_Id,
        src.Accrual_Date_For_Expenses_Dt,
        src.Business_Record_Dt,
        src.Cancellation_Dt,
        src.Cost_Element,
        src.Accounting_Area_General_Ledger_Id,
        src.Accrual_Date_For_Revenue_Dt,
        src.Cancellation_Flag,
        src.Creation_Dt,
        src.Cancellation_Originator,
        src.Event_Dt,
        src.Manual_Posting,
        src.Cancellation_Originator_Instance,
        src.Distribution_Channel_Id,
        src.Manually_Overridden,
        src.Posting_Status,
        src.Cancellation_Originator_Instance_Value,
        src.Manually_Override_Allowed,
        src.Posting_Accounting_Period_Begin_Dt,
        src.Cancellation_Reason,
        src.Origin_Language_Iso,
        src.Posting_Accounting_Period_End_Dt,
        src.Cancellation_Reason_Road,
        src.Origin_System_Type,
        src.Posting_Dt,
        src.Cancellation_Retracted,
        src.Posting_Type,
        src.Processing_Dt,
        src.Cancellation_Type,
        src.Posting_Origin,
        src.Processing_Status,
        src.Transaction_Posting_Id,
        src.Reference_Curr_Rounding_Rule_Amt,
        src.Storno_Version_Nbr,
        src.Status_Indicator,
        src.Transaction_Amt,
        src.Transaction_Desc,
        src.Transaction_Reference_Id,
        src.Transaction_Type,
        src.Transaction_Unit,
        src.Accident_Year,
        src.Country,
        src.Asset_Class,
        src.Movement_Type,
        src.Reinsurance_Cover_Type,
        src.Risk_Location,
        src.Underwriting_Year,
        src.Reinsurance_Type,
        src.Document_Type
FROM

    (
        SELECT
        stg.Posting_Bk,
        stg.H_Posting_Hk,
        stg.Invalid_Dts,
        md5(
                CONCAT(
                    NVL(stg.Company_Cd, '~Null~'),
                    NVL(stg.Cost_Unit, '~Null~'),
                    NVL(stg.Transaction_Id, '~Null~'),
                    NVL(stg.Accrual_Date_For_Expenses_Dt, '~Null~'),
                    NVL(stg.Business_Record_Dt, '~Null~'),
                    NVL(stg.Cancellation_Dt, '~Null~'),
                    NVL(stg.Cost_Element, '~Null~'),
                    NVL(stg.Accounting_Area_General_Ledger_Id, '~Null~'),
                    NVL(stg.Accrual_Date_For_Revenue_Dt, '~Null~'),
                    NVL(stg.Cancellation_Flag, '~Null~'),
                    NVL(stg.Creation_Dt, '~Null~'),
                    NVL(stg.Cancellation_Originator, '~Null~'),
                    NVL(stg.Event_Dt, '~Null~'),
                    NVL(stg.Manual_Posting, '~Null~'),
                    NVL(stg.Cancellation_Originator_Instance, '~Null~'),
                    NVL(stg.Distribution_Channel_Id, '~Null~'),
                    NVL(stg.Manually_Overridden, '~Null~'),
                    NVL(stg.Posting_Status, '~Null~'),
                    NVL(stg.Cancellation_Originator_Instance_Value, '~Null~'),
                    NVL(stg.Manually_Override_Allowed, '~Null~'),
                    NVL(stg.Posting_Accounting_Period_Begin_Dt, '~Null~'),
                    NVL(stg.Cancellation_Reason, '~Null~'),
                    NVL(stg.Origin_Language_Iso, '~Null~'),
                    NVL(stg.Posting_Accounting_Period_End_Dt, '~Null~'),
                    NVL(stg.Cancellation_Reason_Road, '~Null~'),
                    NVL(stg.Origin_System_Type, '~Null~'),
                    NVL(stg.Posting_Dt, '~Null~'),
                    NVL(stg.Cancellation_Retracted, '~Null~'),
                    NVL(stg.Posting_Type, '~Null~'),
                    NVL(stg.Processing_Dt, '~Null~'),
                    NVL(stg.Cancellation_Type, '~Null~'),
                    NVL(stg.Posting_Origin, '~Null~'),
                    NVL(stg.Processing_Status, '~Null~'),
                    NVL(stg.Transaction_Posting_Id, '~Null~'),
                    NVL(stg.Reference_Curr_Rounding_Rule_Amt, '~Null~'),
                    NVL(stg.Storno_Version_Nbr, '~Null~'),
                    NVL(stg.Status_Indicator, '~Null~'),
                    NVL(stg.Transaction_Amt, '~Null~'),
                    NVL(stg.Transaction_Desc, '~Null~'),
                    NVL(stg.Transaction_Reference_Id, '~Null~'),
                    NVL(stg.Transaction_Type, '~Null~'),
                    NVL(stg.Transaction_Unit, '~Null~'),
                    NVL(stg.Accident_Year, '~Null~'),
                    NVL(stg.Country, '~Null~'),
                    NVL(stg.Asset_Class, '~Null~'),
                    NVL(stg.Movement_Type, '~Null~'),
                    NVL(stg.Reinsurance_Cover_Type, '~Null~'),
                    NVL(stg.Risk_Location, '~Null~'),
                    NVL(stg.Underwriting_Year, '~Null~'),
                    NVL(stg.Reinsurance_Type, '~Null~'),
                    NVL(stg.Document_Type, '~Null~')
                )
            ) AS Hash_Diff,
        CONCAT("rs_posting_at_vvs", '~', stg.Rec_Src) AS Rec_Src,
        '{Source_System}' AS Source_System,
        stg.Company_Cd,
        stg.Cost_Unit,
        stg.Transaction_Id,
        stg.Accrual_Date_For_Expenses_Dt,
        stg.Business_Record_Dt,
        stg.Cancellation_Dt,
        stg.Cost_Element,
        stg.Accounting_Area_General_Ledger_Id,
        stg.Accrual_Date_For_Revenue_Dt,
        stg.Cancellation_Flag,
        stg.Creation_Dt,
        stg.Cancellation_Originator,
        stg.Event_Dt,
        stg.Manual_Posting,
        stg.Cancellation_Originator_Instance,
        stg.Distribution_Channel_Id,
        stg.Manually_Overridden,
        stg.Posting_Status,
        stg.Cancellation_Originator_Instance_Value,
        stg.Manually_Override_Allowed,
        stg.Posting_Accounting_Period_Begin_Dt,
        stg.Cancellation_Reason,
        stg.Origin_Language_Iso,
        stg.Posting_Accounting_Period_End_Dt,
        stg.Cancellation_Reason_Road,
        stg.Origin_System_Type,
        stg.Posting_Dt,
        stg.Cancellation_Retracted,
        stg.Posting_Type,
        stg.Processing_Dt,
        stg.Cancellation_Type,
        stg.Posting_Origin,
        stg.Processing_Status,
        stg.Transaction_Posting_Id,
        stg.Reference_Curr_Rounding_Rule_Amt,
        stg.Storno_Version_Nbr,
        stg.Status_Indicator,
        stg.Transaction_Amt,
        stg.Transaction_Desc,
        stg.Transaction_Reference_Id,
        stg.Transaction_Type,
        stg.Transaction_Unit,
        stg.Accident_Year,
        stg.Country,
        stg.Asset_Class,
        stg.Movement_Type,
        stg.Reinsurance_Cover_Type,
        stg.Risk_Location,
        stg.Underwriting_Year,
        stg.Reinsurance_Type,
        stg.Document_Type
    FROM (
        SELECT
            Posting_Bk,
            H_Posting_Hk,
            Invalid_Dts,
            Rec_Src,
            Source_System,
            Null AS Company_Cd,
            Null AS Cost_Unit,
            Null AS Transaction_Id,
            Null AS Accrual_Date_For_Expenses_Dt,
            Null AS Business_Record_Dt,
            Null AS Cancellation_Dt,
            Null AS Cost_Element,
            Null AS Accounting_Area_General_Ledger_Id,
            Null AS Accrual_Date_For_Revenue_Dt,
            Null AS Cancellation_Flag,
            Null AS Creation_Dt,
            Null AS Cancellation_Originator,
            Null AS Event_Dt,
            Null AS Manual_Posting,
            Null AS Cancellation_Originator_Instance,
            Null AS Distribution_Channel_Id,
            Null AS Manually_Overridden,
            Null AS Posting_Status,
            Null AS Cancellation_Originator_Instance_Value,
            Null AS Manually_Override_Allowed,
            Null AS Posting_Accounting_Period_Begin_Dt,
            Null AS Cancellation_Reason,
            Null AS Origin_Language_Iso,
            Null AS Posting_Accounting_Period_End_Dt,
            Null AS Cancellation_Reason_Road,
            Null AS Origin_System_Type,
            Null AS Posting_Dt,
            Null AS Cancellation_Retracted,
            Null AS Posting_Type,
            Null AS Processing_Dt,
            Null AS Cancellation_Type,
            Source AS Posting_Origin,
            Null AS Processing_Status,
            Null AS Transaction_Posting_Id,
            Null AS Reference_Curr_Rounding_Rule_Amt,
            Null AS Storno_Version_Nbr,
            Null AS Status_Indicator,
            Null AS Transaction_Amt,
            Posting_Desc AS Transaction_Desc,
            Null AS Transaction_Reference_Id,
            Null AS Transaction_Type,
            Null AS Transaction_Unit,
            Null AS Accident_Year,
            Country,
            Null AS Asset_Class,
            Null AS Movement_Type,
            Null AS Reinsurance_Cover_Type,
            Null AS Risk_Location,
            Null AS Underwriting_Year,
            Null AS Reinsurance_Type,
            Document_Type
        FROM
            fdp.rdv.RS_POSTING_AT_VVS
    ) stg
    ) src
    LEFT OUTER JOIN (
        SELECT
            H_Posting_Hk,
            Hash_Diff
        FROM
            fdp.bdv.BS_POSTING
        WHERE
            Source_System = '{Source_System}'
    ) tgt ON src.H_Posting_Hk = tgt.H_Posting_Hk
    WHERE
        tgt.H_Posting_Hk IS NULL
        OR (
            tgt.H_Posting_Hk IS NOT NULL
            AND src.Hash_Diff <> tgt.Hash_Diff
        )
        AND src.Invalid_dts = '9999-12-31 23:59:59'
    """
)
